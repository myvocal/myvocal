{"version":3,"sources":["../../display/dist/constants/index.js","../../display/dist/utils/index.js","../../display/dist/pitch-display/index.js","components/pitch/index.tsx","constants/colors.js","components/pitch/pitch-monitor.tsx","components/circle-chart/utils.tsx","components/circle-chart/circle-chat.tsx","model.ts","components/side-nav/side-nav.tsx","components/main/options.tsx","components/main/app-frame.tsx","components/main/about.tsx","App.tsx","reportWebVitals.ts","index.tsx","services/s1Encoding.js"],"names":["NOTE_STRINGS","OCTAVE_COLORS","noteFromPitch","frequency","noteNum","Math","log","round","centsOffFromPitch","note","floor","pow","frequencyFromNoteNumber","colorFromNote","octave","idx","min","length","max","PitchDisplay","container","timeSpan","this","frequencies","melodyNotes","background","highlight","style","position","canvasStyle","bgCanvas","document","createElement","setAttribute","bgContext","getContext","melodyCanvas","melodyContext","noteCanvas","noteContext","appendChild","lastSongPos","speedChanged","undefined","playingSpeed","resize","w","clientWidth","h","clientHeight","width","height","scaleX","scaleLinear","domain","range","margin","scaleY","render","push","filter","val","now","time","changePlayingSpeed","speed","Date","getTime","calculateSongPos","full","songPos","cleanupFrequencies","drawBackground","drawMelody","drawNotes","color","fillStyle","clearRect","fillRect","i","y","font","fillText","beginPath","strokeStyle","notes","t","f","c","clarity","centsOff","x","stroke","moveTo","lineTo","arc","PI","fill","ctx","lineWidth","start","duration","pitch","startX","endX","FastForwardButton","onPress","onRelease","onMouseDown","onMouseUp","PauseButton","PitchComponent","displayElement","React","createRef","pitchDisplay","lastRender","continuousUpdate","onResize","readNotes","current","setBackgroundColor","setMelodyNotes","playSong","startRender","updatePitch","requestAnimationFrame","window","addEventListener","removeEventListener","params","qs","parse","location","search","substr","s1","decodeS1","error","alert","toString","props","freq","pushFrequency","Fragment","className","ref","pauseSong","bottom","left","fastForwardSong","right","Component","PitchMonitor","stream","detectorName","workerConnection","windowSize","powerThreshold","clarityThreshold","enabled","pitchRenderer","useState","setFreq","setClarity","pendingRef","useRef","pitchSetupRef","setupConnection","useCallback","a","remoteHandle","call","pitchSetup","buffer","Float32Array","audioContext","AudioContext","mediaStreamSource","createMediaStreamSource","analyser","createAnalyser","fftSize","connect","console","warn","getFloatTimeDomainData","sampleRate","result","useEffect","escape","cancelRender","renderFrame","PitchRenderer","LOG_A","log2","radialBoxLayoutOffsets","angle","r","pi","tan","arctan","atan","sqrt","sin","cos","outx","outy","criticalrange1","criticalrange2","b","B","NOTE_SYMBOLS_SHARP","C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","NOTE_SYMBOLS_FLAT","Frequency","hz","noteSymbols","noteFormat","Object","keys","logNote","rot","freqToNote","CircleChartBackground","memo","canvas","noteRefs","cX","cY","outerR","innerR","options","offsetAngle","ring","Path2D","ticks","tickLen","vecX","vecY","drawCircleChartBackground","div","getBoundingClientRect","divW","divH","ox","oy","top","map","CircleChart","setW","setH","surroundingDivRef","canvasPointerRef","computeInnerAndOuterRadius","freqToAngle","useLayoutEffect","handleResize","pointerContext","opacity","vec_x","vec_y","nvec_x","nvec_y","lineJoin","drawCircleChartArrow","transformOrigin","transform","visibility","store","createStore","displayType","loading","loaded","audioOptions","audio","echoCancellation","autoGainControl","setWindowSize","action","state","payload","setDetectorName","setDisplayType","setClarityThreshold","setEnabled","setStream","setLoading","setLoaded","setWorkerConnection","initializeStream","thunk","actions","getState","navigator","mediaDevices","getUserMedia","stopStream","getTracks","stop","initializeWorker","worker","Worker","process","messenger","WorkerMessenger","ParentHandshake","connection","typedHooks","createTypedHooks","useStoreActions","useStoreState","useStoreDispatch","SideNavContext","createContext","expanded","toggleExpanded","Toggle","useContext","type","aria-label","aria-controls","onClick","NavItem","children","rest","_rest","NavIcon","NavText","NavExtra","SideNav","assign","_expanded","onToggle","setExpanded","Provider","value","Nav","Select","_selected","selected","_onSelect","onSelect","choices","setSelected","selectedIndex","findIndex","item","DropdownButton","index","title","desc","variant","as","Dropdown","Item","eventKey","SelectWindowSize","SelectDetector","SelectClarityThreshold","Form","Group","Control","step","onChange","e","parseFloat","target","SelectDisplayType","AppFrame","menuExpanded","setMenuExpanded","running","setRunning","Navbar","bg","Brand","size","ListGroup","role","About","href","rel","App","mainDisplay","reportWebVitals","onPerfEntry","Function","then","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","StrictMode","getElementById","PRECISION","SHORT_BITS","LONG_BITS","data","base64","replace","unsafeBase64","Buffer","from","Error","checksum","origChecksum","readUInt16BE","lastEnd","pos","bytes","readUIntBE"],"mappings":"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","file":"static/js/main.ade9abca.chunk.js","sourcesContent":["export const NOTE_STRINGS = [\"C\", \"D♭\", \"D\", \"E♭\", \"E\", \"F\", \"G♭\", \"G\", \"A♭\", \"A\", \"B♭\", \"B\"];\nexport const OCTAVE_COLORS = [\n    [121, 85, 72],\n    [158, 158, 158],\n    [96, 125, 139],\n    [76, 175, 80],\n    [244, 67, 54],\n    [33, 150, 243],\n    [0, 150, 136],\n    [255, 235, 59],\n    [0, 188, 212],\n];\n","import { OCTAVE_COLORS } from '../constants';\nexport function noteFromPitch(frequency) {\n    let noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));\n    return Math.round(noteNum) + 69;\n}\nexport function frequencyFromNoteNumber(note) {\n    return 440 * Math.pow(2, (note - 69) / 12);\n}\nexport function centsOffFromPitch(frequency, note) {\n    return Math.floor(1200 * Math.log(frequency / frequencyFromNoteNumber(note)) / Math.log(2));\n}\nexport function colorFromNote(note) {\n    let octave = Math.floor(note / 12) - 1;\n    let idx = Math.min(octave, OCTAVE_COLORS.length - 1);\n    idx = Math.max(0, idx);\n    return OCTAVE_COLORS[idx];\n}\n","import { scaleLinear } from 'd3-scale';\nimport { NOTE_STRINGS } from '../constants';\nimport { noteFromPitch, colorFromNote, centsOffFromPitch } from '../utils';\nclass PitchDisplay {\n    constructor(container, timeSpan = 15000) {\n        this.frequencies = [];\n        this.melodyNotes = [];\n        this.background = '#efefef';\n        this.highlight = '#888888';\n        this.container = container;\n        this.container.style.position = \"relative\";\n        const canvasStyle = \"position: absolute; width: 100%; height: 100%;\";\n        this.bgCanvas = document.createElement(\"canvas\");\n        this.bgCanvas.setAttribute(\"style\", canvasStyle);\n        this.bgContext = this.bgCanvas.getContext('2d');\n        this.melodyCanvas = document.createElement(\"canvas\");\n        this.melodyCanvas.setAttribute(\"style\", canvasStyle);\n        this.melodyContext = this.melodyCanvas.getContext('2d');\n        this.noteCanvas = document.createElement(\"canvas\");\n        this.noteCanvas.setAttribute(\"style\", canvasStyle);\n        this.noteContext = this.noteCanvas.getContext('2d');\n        this.container.appendChild(this.bgCanvas);\n        this.container.appendChild(this.melodyCanvas);\n        this.container.appendChild(this.noteCanvas);\n        this.timeSpan = timeSpan;\n        this.lastSongPos = 0;\n        this.speedChanged = undefined;\n        this.playingSpeed = 0;\n        this.resize();\n    }\n    resize() {\n        let w = this.container.clientWidth;\n        let h = this.container.clientHeight;\n        this.bgCanvas.width = w;\n        this.bgCanvas.height = h;\n        this.melodyCanvas.width = w;\n        this.melodyCanvas.height = h;\n        this.noteCanvas.width = w;\n        this.noteCanvas.height = h;\n        this.scaleX = scaleLinear()\n            .domain([-(this.timeSpan / 2), this.timeSpan / 2])\n            .range([0, w]);\n        let margin = h / (NOTE_STRINGS.length + 1);\n        this.scaleY = scaleLinear()\n            .domain([0, NOTE_STRINGS.length - 1])\n            .range([h - margin, margin]);\n        this.render();\n    }\n    pushFrequency(frequency) {\n        this.frequencies.push(frequency);\n    }\n    cleanupFrequencies() {\n        // Throw away the frequencies that are out of the current display window\n        this.frequencies = this.frequencies.filter((val) => this.now - val.time < this.timeSpan / 2);\n    }\n    setMelodyNotes(melodyNotes) {\n        this.melodyNotes = melodyNotes;\n    }\n    playSong() {\n        this.changePlayingSpeed(1);\n    }\n    fastForwardSong() {\n        this.changePlayingSpeed(3);\n    }\n    pauseSong() {\n        this.changePlayingSpeed(0);\n    }\n    calculateSongPos(now) {\n        return this.lastSongPos + this.playingSpeed * (now - this.speedChanged);\n    }\n    changePlayingSpeed(speed) {\n        const now = (new Date()).getTime();\n        if (this.speedChanged === undefined) {\n            this.speedChanged = now;\n        }\n        this.lastSongPos = this.calculateSongPos(now);\n        this.playingSpeed = speed;\n        this.speedChanged = now;\n    }\n    render(full = true) {\n        this.now = (new Date()).getTime();\n        // calculate song position\n        const songPos = this.calculateSongPos(this.now);\n        this.cleanupFrequencies();\n        if (full) {\n            this.drawBackground();\n        }\n        this.drawMelody(songPos);\n        this.drawNotes();\n    }\n    setBackgroundColor(color) {\n        this.background = color;\n        this.drawBackground();\n    }\n    setHighlightColor(color) {\n        this.highlight = color;\n        this.drawBackground();\n    }\n    drawBackground() {\n        let w = this.bgCanvas.width;\n        let h = this.bgCanvas.height;\n        this.bgContext.fillStyle = this.background;\n        this.bgContext.clearRect(0, 0, w, h);\n        this.bgContext.fillRect(0, 0, w, h);\n        for (let i = 0; i < NOTE_STRINGS.length; ++i) {\n            let y = this.scaleY(i);\n            this.bgContext.fillStyle = this.highlight + '55';\n            this.bgContext.fillRect(0, y, w, 1);\n            this.bgContext.fillStyle = this.highlight;\n            this.bgContext.font = '14px Sans';\n            this.bgContext.fillText(NOTE_STRINGS[i], this.scaleX(0) + 20, y - 2);\n        }\n        this.bgContext.fillStyle = this.highlight + '55';\n        this.bgContext.fillRect(this.scaleX(0), 0, 1, h);\n    }\n    drawNotes() {\n        let w = this.noteCanvas.width;\n        let h = this.noteCanvas.height;\n        this.noteContext.clearRect(0, 0, w, h);\n        this.noteContext.beginPath();\n        this.noteContext.strokeStyle = 'rgba(0, 0, 0, 0.1)';\n        // Calculate notes and colors from frequencies\n        const notes = [];\n        for (let frequency of this.frequencies) {\n            let t = frequency.time;\n            let f = frequency.frequency;\n            let c = frequency.clarity;\n            let note = noteFromPitch(f);\n            let centsOff = centsOffFromPitch(f, note);\n            let x = this.scaleX(t - this.now);\n            let y = this.scaleY(note % 12 + centsOff / 100);\n            let color = colorFromNote(note);\n            notes.push({\n                time: t,\n                x,\n                y,\n                clarity: c,\n                color\n            });\n        }\n        // Draw lines\n        const timeCutoff = 500;\n        this.noteContext.beginPath();\n        for (let i = 1; i < notes.length; ++i) {\n            const { x, y, time } = notes[i];\n            const prevTime = notes[i - 1].time;\n            if (time - prevTime > timeCutoff) {\n                this.noteContext.stroke();\n                this.noteContext.beginPath();\n                this.noteContext.moveTo(x, y);\n            }\n            else {\n                this.noteContext.lineTo(x, y);\n            }\n        }\n        this.noteContext.stroke();\n        // Draw circles\n        for (let note of notes) {\n            const { x, y, clarity, color } = note;\n            this.noteContext.fillStyle = `rgba(${color[0]}, ${color[1]}, ${color[2]}, ${clarity * 0.5})`;\n            this.noteContext.beginPath();\n            this.noteContext.arc(x, y, 3, 0, Math.PI * 2);\n            this.noteContext.fill();\n        }\n    }\n    drawMelody(songPos) {\n        let w = this.melodyCanvas.width;\n        let h = this.melodyCanvas.height;\n        const ctx = this.melodyContext;\n        ctx.clearRect(0, 0, w, h);\n        ctx.strokeStyle = 'rgba(0, 255, 0, 1)';\n        ctx.lineWidth = h / 24;\n        for (let note of this.melodyNotes) {\n            const { start, duration, pitch } = note;\n            const startX = this.scaleX(start - songPos);\n            const endX = this.scaleX(start - songPos + duration);\n            const y = this.scaleY(pitch % 12);\n            ctx.beginPath();\n            ctx.moveTo(startX, y);\n            ctx.lineTo(endX, y);\n            ctx.stroke();\n        }\n    }\n}\nexport { PitchDisplay };\n","import React, { Component } from 'react';\nimport qs from 'qs';\n\nimport { PitchDisplay } from 'pitch-display';\n\nimport { BACKGROUND } from '../../constants/colors';\nimport { decodeS1 } from '../../services/s1Encoding';\n\nexport interface PitchProps {\n  freq: number | null;\n  clarity: number | null;\n}\n\nfunction FastForwardButton({ onPress, onRelease, style }) {\n  return (\n    <div style={style} onMouseDown={onPress} onMouseUp={onRelease}>\n      FAST FORWARD\n    </div>\n  );\n}\n\nfunction PauseButton({ onPress, onRelease, style }) {\n  return (\n    <div style={style} onMouseDown={onPress} onMouseUp={onRelease}>\n      PAUSE\n    </div>\n  );\n}\n\nclass PitchComponent extends Component<PitchProps> {\n  displayElement = React.createRef<HTMLDivElement>();\n  pitchDisplay?: PitchDisplay;\n  lastRender: number = 0;\n  continuousUpdate: boolean = true;\n  notes: [];\n\n  componentDidMount() {\n    this.readNotes();\n\n    this.pitchDisplay = new PitchDisplay(\n      this.displayElement.current!,\n      6000\n    );\n    this.pitchDisplay.setBackgroundColor(BACKGROUND);\n    this.pitchDisplay.setMelodyNotes(this.notes);\n    this.pitchDisplay.playSong();\n\n    // We want to ensure `pitchDisplay` updates at regular\n    // time intervals even if the note has not changed (so\n    // that the display continues scrolling)\n    const startRender = () => {\n      this.updatePitch();\n      if (this.continuousUpdate) {\n        requestAnimationFrame(startRender);\n      }\n    };\n    startRender();\n    window.addEventListener('resize', this.onResize);\n  }\n\n  componentWillUnmount() {\n    this.continuousUpdate = false;\n    window.removeEventListener('resize', this.onResize);\n  }\n\n  readNotes() {\n    // decode notes from query parameter\n    this.notes = [];\n    const params = qs.parse(window.location.search.substr(1));\n    if (params.s1) {\n      try {\n        this.notes = decodeS1(params.s1);\n      } catch (error) {\n        alert(error.toString());\n      }\n    }\n  }\n\n  onResize = () => {\n    if (this.pitchDisplay) {\n      this.pitchDisplay.resize();\n    }\n  };\n\n  updatePitch() {\n    const time = new Date().getTime();\n    if (time - this.lastRender < 17) {\n      // We don't want to render faster than 60fps\n      return;\n    }\n    if (!this.pitchDisplay) {\n      return;\n    }\n    const { freq, clarity } = this.props;\n    if (freq && freq > 0) {\n      this.pitchDisplay.pushFrequency({\n        frequency: freq,\n        clarity: clarity || 0,\n        time,\n      });\n    }\n    this.lastRender = time;\n    this.pitchDisplay.render(false);\n  }\n\n  render() {\n    this.updatePitch();\n    const fastForwardStyle = {\n      position: 'absolute',\n      bottom: 40,\n      right: 40,\n    };\n    const pauseStyle = {\n      position: 'absolute',\n      bottom: 40,\n      left: 80,\n    };\n    return (\n      <React.Fragment>\n        <div\n          className=\"full\"\n          style={{ position: 'relative' }}\n          ref={this.displayElement}\n        />\n        <PauseButton\n          onPress={() => this.pitchDisplay.pauseSong()}\n          onRelease={() => this.pitchDisplay.playSong()}\n          style={pauseStyle}\n        />\n        <FastForwardButton\n          onPress={() => this.pitchDisplay.fastForwardSong()}\n          onRelease={() => this.pitchDisplay.playSong()}\n          style={fastForwardStyle}\n        />\n      </React.Fragment>\n    );\n  }\n}\n\nexport default PitchComponent;\n","export const BACKGROUND = '#F5F5F5';\n\nexport const PRIMARY = '#3f51b5';\nexport const PRIMARY_LIGHT = '#757de8';\nexport const PRIMARY_DARK = '#002984';\nexport const PRIMARY_TEXT = '#ffffff';\n\nexport const SECONDARY = '#9c27b0';\nexport const SECONDARY_LIGHT = '#d05ce3';\nexport const SECONDARY_DARK = '#6a0080';\nexport const SECONDARY_TEXT = '#ffffff';\n","import { Connection } from 'post-me';\nimport React from 'react';\nimport { WorkerMethods } from '../../../worker/types';\n\ninterface PitchSetup {\n  analyser?: AnalyserNode;\n  audioContext?: AudioContext;\n  buffer?: Float32Array;\n}\ninterface PitchProps {\n  stream: MediaStream;\n  workerConnection: Connection<{}, WorkerMethods, {}>;\n  detectorName: 'autocorrelation' | 'mcleod';\n  windowSize: number;\n  powerThreshold: number;\n  clarityThreshold: number;\n  enabled: boolean;\n  pitchRenderer: React.ComponentType<{\n    freq: number | null;\n    clarity: number | null;\n  }>;\n}\n\n/**\n * While `enabled` is truthy, get the pitch from the input source,\n * and pass its frequency and clarity to `pitchRenderer`.\n *\n * `pitchRenderer` should be a react component that accepts `freq` and `clarity`\n * props.\n *\n * @export\n * @param {PitchProps} {\n *   stream,\n *   detectorName,\n *   workerConnection,\n *   windowSize,\n *   powerThreshold,\n *   clarityThreshold,\n *   enabled,\n *   pitchRenderer,\n * }\n * @returns\n */\nexport function PitchMonitor({\n  stream,\n  detectorName,\n  workerConnection,\n  windowSize,\n  powerThreshold,\n  clarityThreshold,\n  enabled,\n  pitchRenderer,\n}: PitchProps) {\n  const [freq, setFreq] = React.useState<number | null>(null);\n  const [clarity, setClarity] = React.useState<number | null>(null);\n  const pendingRef = React.useRef(false);\n  const pitchSetupRef = React.useRef<PitchSetup>({});\n\n  // Gets called first-thing whenever this component's props change.\n  const setupConnection = React.useCallback(async () => {\n    await workerConnection\n      .remoteHandle()\n      .call('createDetector', detectorName, windowSize, windowSize / 2);\n    const pitchSetup = pitchSetupRef.current;\n    pitchSetup.buffer = new Float32Array(windowSize);\n    pitchSetup.audioContext = new AudioContext();\n    // Create an AudioNode from the stream.\n    const mediaStreamSource = pitchSetup.audioContext.createMediaStreamSource(\n      stream\n    );\n    // Connect it to the destination.\n    pitchSetup.analyser = pitchSetup.audioContext.createAnalyser();\n    pitchSetup.analyser.fftSize = windowSize;\n    mediaStreamSource.connect(pitchSetup.analyser);\n  }, [pitchSetupRef, windowSize, detectorName, stream, workerConnection]);\n\n  // Find the current pitch/clarity and save it in `freq`/`clarity`.\n  const updatePitch = React.useCallback(async () => {\n    if (!pendingRef.current) {\n      pendingRef.current = true;\n\n      const pitchSetup = pitchSetupRef.current;\n      const { analyser, buffer, audioContext } = pitchSetup;\n      if (!analyser || !buffer || !audioContext) {\n        console.warn(\n          'Trying to update the pitch, but missing an analyser/buffer/audioContext'\n        );\n        return;\n      }\n      analyser.getFloatTimeDomainData(buffer);\n      const result = await workerConnection\n        .remoteHandle()\n        .call(\n          'getPitch',\n          buffer,\n          audioContext.sampleRate,\n          powerThreshold,\n          clarityThreshold\n        );\n      const frequency = result[0];\n      const clarity = result[1];\n      if (frequency > 0) {\n        setFreq(frequency);\n        setClarity(clarity);\n      } else {\n        setFreq(null);\n        setClarity(null);\n      }\n\n      pendingRef.current = false;\n    }\n  }, [\n    pendingRef,\n    pitchSetupRef,\n    setFreq,\n    setClarity,\n    powerThreshold,\n    clarityThreshold,\n    workerConnection,\n  ]);\n\n  // This function only gets called when the dependencies update, and it automatically\n  // cleans up when it is called subsequent times. It starts an endless loop\n  // of computing the current pitch.\n  React.useEffect(() => {\n    if (!enabled) {\n      // This function runs whenever the state of `enabled` changes.\n      // When this function is re-run, it automatically cancels the\n      // the audio monitoring, so all we need to do is return here.\n      return;\n    }\n    console.log('Starting audio monitoring.');\n    const escape = { cancelRender: false };\n    function renderFrame() {\n      if (escape.cancelRender) {\n        return;\n      }\n      requestAnimationFrame(renderFrame);\n      updatePitch();\n    }\n    (async () => {\n      await setupConnection();\n      renderFrame();\n    })();\n\n    return () => {\n      console.log('Stopping audio monitoring.');\n      escape.cancelRender = true;\n    };\n  }, [setupConnection, updatePitch, enabled]);\n\n  const PitchRenderer = pitchRenderer;\n  return <PitchRenderer freq={freq} clarity={clarity} />;\n}\n","import { Note, NOTE_SYMBOLS_SHARP } from './circle-chat';\n\nexport function freqToNote(freq: number): { note: Note; octave: number } {\n  const notes = Object.keys(NOTE_SYMBOLS_SHARP) as Note[];\n  const logNote = Math.log2(freq) - LOG_A;\n  // LOG_A is the log of A_4\n  const octave = Math.floor(logNote) + 4;\n  const rot = (((logNote - 0.25) % 1) + 1) % 1;\n  for (let i = 0; i < 12; i++) {\n    const low = i / 12 - 1 / 24;\n    const hi = i / 12 + 1 / 24;\n    if (rot > low && rot <= hi) {\n      return { note: notes[i], octave };\n    }\n  }\n  return { note: 'C', octave };\n}\n\n// The log of A_4\nconst LOG_A = Math.log2(440);\n\n/**\n * Convert a frequency to an angle in radians. The frequency\n * of a \"C\" is at the top of the circle.\n *\n * @export\n * @param {number} freq\n * @returns {number}\n */\nexport function freqToAngle(freq: number): number {\n  // We subtract 0.5, because A is halfway around the circle chart from 0 deg.\n  return ((((Math.log2(freq) - LOG_A - 0.5) % 1) + 1) % 1) * Math.PI * 2;\n}\n\n/**\n * Computes the inner and outer radius for the circle chart\n * based on the available size.\n *\n * @param {number} w\n * @param {number} h\n * @returns\n */\nexport function computeInnerAndOuterRadius(w: number, h: number) {\n  const outerR = Math.min(w, h) / 3;\n  const innerR = outerR * 0.6;\n  return { innerR, outerR };\n}\n\n/**\n * Compute the offset from the center of a circle of radius `r` that a box\n * of width/height `w`/`h` needs to have to be tangent to the circle.\n *\n * @param {number} angle - angle in which to compute the displacement\n * @param {number} r - radius of the circle\n * @param {number} w - width of the box\n * @param {number} h - height of the box\n * @returns {[number, number]} - displacement of the lower-left corner of the box to be tangent\n */\nexport function radialBoxLayoutOffsets(\n  angle: number,\n  r: number,\n  w: number,\n  h: number\n): [number, number] {\n  angle = ((angle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);\n\n  // This code was ported from Python. It's just easier to\n  // rename the math functions.\n  const pi = Math.PI;\n  const tan = Math.tan;\n  const arctan = Math.atan;\n  const sqrt = Math.sqrt;\n  const sin = Math.sin;\n  const cos = Math.cos;\n\n  let [outx, outy] = [0, 0];\n\n  if (r === 0) {\n    return [outx, outy];\n  }\n\n  const criticalrange1 = arctan(w / 2.0 / (r + h / 2.0));\n  const criticalrange2 = arctan(w / 2.0 / (r + h / 2.0));\n\n  // Edge is touching\n  if (angle < 0 + criticalrange1 || angle > 2 * pi - criticalrange1) {\n    outx = r;\n    outy = -(r + w / 2) * tan(angle) - h / 2.0;\n  } else if (angle > pi - criticalrange1 && angle < pi + criticalrange1) {\n    outx = -r - w;\n    outy = -(r + w / 2) * tan(pi - angle) - h / 2.0;\n  } else if (\n    angle > pi / 2 - criticalrange2 &&\n    angle < pi / 2 + criticalrange2\n  ) {\n    outx =\n      sqrt((w * w) / 4.0 + (r + h / 2.0) * (r + h / 2.0)) *\n        sin(pi / 2.0 - angle) -\n      w / 2.0;\n    outy = -(r + h);\n  } else if (\n    angle > (pi * 3) / 2 - criticalrange2 &&\n    angle < (pi * 3) / 2 + criticalrange2\n  ) {\n    outx =\n      sqrt((w * w) / 4.0 + (r + h / 2.0) * (r + h / 2.0)) *\n        sin(pi / 2 - angle) -\n      w / 2;\n    outy = r;\n  }\n  // Corner is touching\n  else if (angle >= 0 + criticalrange1 && angle <= pi / 2 - criticalrange2) {\n    const a = sqrt((w * w) / 4.0 + (h * h) / 4.0);\n    const b = r;\n    const B = angle - arctan(h / w);\n    const c = sqrt(b * b + (cos(B) * cos(B) - 1) * a * a) + cos(B) * a;\n    outx = c * cos(angle) - w / 2.0;\n    outy = -(c * sin(angle) + h / 2.0);\n  } else if (angle >= pi / 2 + criticalrange2 && angle <= pi - criticalrange1) {\n    //adjust angle so we can pretend we're in the first quadrant\n    angle = pi - angle;\n    const a = sqrt((w * w) / 4.0 + (h * h) / 4.0);\n    const b = r;\n    const B = angle - arctan(h / w);\n    const c = sqrt(b * b + (cos(B) * cos(B) - 1) * a * a) + cos(B) * a;\n    outx = -(c * cos(angle) - w / 2) - w;\n    outy = -(c * sin(angle) + h / 2);\n  } else if (\n    angle >= pi + criticalrange1 &&\n    angle <= (pi * 3) / 2 - criticalrange2\n  ) {\n    // adjust angle so we can pretend we're in the first quadrant\n    angle -= pi;\n    const a = sqrt((w * w) / 4 + (h * h) / 4);\n    const b = r;\n    const B = angle - arctan(h / w);\n    const c = sqrt(b * b + (cos(B) * cos(B) - 1) * a * a) + cos(B) * a;\n    outx = -c * cos(angle) - w / 2;\n    outy = c * sin(angle) - h / 2;\n  } else if (\n    angle >= (pi * 3) / 2 + criticalrange2 &&\n    angle <= 2 * pi - criticalrange1\n  ) {\n    // adjust angle so we can pretend we're in the first quadrant\n    angle = 2 * pi - angle;\n    const a = sqrt((w * w) / 4 + (h * h) / 4);\n    const b = r;\n    const B = angle - arctan(h / w);\n    const c = sqrt(b * b + (cos(B) * cos(B) - 1) * a * a) + cos(B) * a;\n    outx = c * cos(angle) - w / 2;\n    outy = c * sin(angle) - h / 2;\n  }\n\n  return [outx, outy];\n}\n","import React from 'react';\nimport {\n  computeInnerAndOuterRadius,\n  freqToAngle,\n  freqToNote,\n  radialBoxLayoutOffsets,\n} from './utils';\n\nexport type Note =\n  | 'C'\n  | 'Db'\n  | 'D'\n  | 'Eb'\n  | 'E'\n  | 'F'\n  | 'Gb'\n  | 'G'\n  | 'Ab'\n  | 'A'\n  | 'Bb'\n  | 'B';\n\nexport const NOTE_SYMBOLS_SHARP: { [key in Note]: string } = {\n  C: 'C',\n  Db: 'C♯',\n  D: 'D',\n  Eb: 'D♯',\n  E: 'E',\n  F: 'F',\n  Gb: 'F♯',\n  G: 'G',\n  Ab: 'G♯',\n  A: 'A',\n  Bb: 'A♯',\n  B: 'B',\n};\nexport const NOTE_SYMBOLS_FLAT: { [key in Note]: string } = {\n  C: 'C',\n  Db: 'D♭',\n  D: 'D',\n  Eb: 'E♭',\n  E: 'E',\n  F: 'F',\n  Gb: 'G♭',\n  G: 'G',\n  Ab: 'A♭',\n  A: 'A',\n  Bb: 'B♭',\n  B: 'B',\n};\n\nexport function drawCircleChartBackground(\n  ctx: CanvasRenderingContext2D,\n  [w, h]: [number, number],\n  options: {\n    innerR?: number;\n    outerR?: number;\n  } = {}\n) {\n  const offsetAngle = 0;\n  const [cX, cY] = [w / 2, h / 2];\n  const outerR = options.outerR ?? Math.min(w, h) / 3;\n  const innerR = options.innerR ?? outerR * 0.6;\n\n  const ring = new Path2D();\n  ring.arc(cX, cY, outerR, 0, 2 * Math.PI);\n  // If we don't move to the start of the next arc, there\n  // will be a line connecting them.\n  ring.moveTo(cX + innerR, cY);\n  ring.arc(cX, cY, innerR, 0, 2 * Math.PI);\n  ctx.fillStyle = 'rgb(204,204,240)';\n  ctx.fill(ring, 'evenodd');\n\n  ctx.strokeStyle = 'rgb(110,102,102)';\n\n  // draw some ticks\n  const ticks = new Path2D();\n  for (let i = 0; i < 5 * 12; i++) {\n    const angle = (i / (5 * 12)) * 2 * Math.PI - offsetAngle;\n    let tickLen = 0.5;\n    if (i % 5 === 0) {\n      // Every fifth tick is long\n      tickLen = 1.0;\n    }\n    const vecX = Math.cos(angle);\n    const vecY = Math.sin(angle);\n    ticks.moveTo(vecX * outerR + cX, vecY * outerR + cY);\n    ticks.lineTo(\n      vecX * (1 - 0.08 * tickLen) * outerR + cX,\n      vecY * (1 - 0.08 * tickLen) * outerR + cY\n    );\n  }\n  ctx.lineWidth = 2;\n  ctx.stroke(ticks);\n\n  ctx.lineWidth = 1;\n  ctx.stroke(ring);\n\n  return { innerR, outerR };\n}\n\nfunction drawCircleChartArrow(\n  ctx: CanvasRenderingContext2D,\n  [w, h]: [number, number],\n  options: {\n    angle: number;\n    opacity: number;\n    innerR: number;\n    outerR: number;\n  }\n) {\n  const { angle, opacity, innerR, outerR } = options;\n  const [vec_x, vec_y] = [Math.cos(angle), Math.sin(angle)];\n  // Compute the normal vector\n  const [nvec_x, nvec_y] = [-vec_y, vec_x];\n\n  ctx.moveTo(\n    vec_x * innerR + 3 * nvec_x + w / 2,\n    -(vec_y * innerR + 3 * nvec_y) + h / 2\n  );\n  ctx.lineTo(\n    vec_x * innerR - 3 * nvec_x + w / 2,\n    -(vec_y * innerR - 3 * nvec_y) + h / 2\n  );\n  ctx.lineTo(vec_x * outerR + w / 2, -(vec_y * outerR) + h / 2);\n\n  ctx.fillStyle = `rgba(0,128,204,${opacity})`;\n  ctx.fill();\n  ctx.strokeStyle = `rgba(0,77,204,${opacity})`;\n  ctx.lineJoin = 'bevel';\n  ctx.stroke();\n}\n\nfunction Frequency({\n  hz,\n  noteFormat,\n}: {\n  hz: number;\n  noteFormat: 'sharp' | 'flat';\n}) {\n  const noteSymbols =\n    noteFormat === 'sharp' ? NOTE_SYMBOLS_SHARP : NOTE_SYMBOLS_FLAT;\n  const { note, octave } = freqToNote(hz);\n  return (\n    <div className=\"freq-container\">\n      <span className=\"freq-note\">\n        {noteSymbols[note]}\n        <span className=\"freq-octave\">{octave}</span>\n      </span>\n      <span className=\"freq-hz\">{Math.round(hz)} Hz</span>\n    </div>\n  );\n}\n\nconst CircleChartBackground = React.memo(function CircleChartBackground({\n  w,\n  h,\n  noteFormat = 'sharp',\n}: {\n  w: number;\n  h: number;\n  noteFormat?: 'sharp' | 'flat';\n}) {\n  const canvas = React.useRef<HTMLCanvasElement>(null);\n  // The note labels are rendered in divs so we can use CSS to style them.\n  // We need to store refs to all these divs so we can dynamically compute their\n  // sizes.\n  const noteRefs = React.useRef<React.RefObject<HTMLDivElement>[]>([\n    { current: null },\n    { current: null },\n    { current: null },\n    { current: null },\n    { current: null },\n    { current: null },\n    { current: null },\n    { current: null },\n    { current: null },\n    { current: null },\n    { current: null },\n    { current: null },\n  ]);\n  const offsetAngle = 0;\n  const [cX, cY] = [w / 2, h / 2];\n  const outerR = Math.min(w, h) / 3;\n  const innerR = outerR * 0.6;\n\n  const noteSymbols =\n    noteFormat === 'sharp' ? NOTE_SYMBOLS_SHARP : NOTE_SYMBOLS_FLAT;\n  const notes = Object.keys(noteSymbols) as Note[];\n\n  React.useEffect(() => {\n    const ctx = canvas.current?.getContext('2d');\n    if (!ctx) {\n      return;\n    }\n\n    drawCircleChartBackground(ctx, [w, h], { innerR, outerR });\n    // Position all the labels\n    for (let i = 0; i < 12; i++) {\n      const angle = (-i / 12.0) * 2 * Math.PI + Math.PI / 2 + offsetAngle;\n      const ref = noteRefs.current[i];\n      if (!ref.current) {\n        continue;\n      }\n      const div = ref.current;\n      const { width: divW, height: divH } = div.getBoundingClientRect();\n      const [ox, oy] = radialBoxLayoutOffsets(angle, outerR + 4, divW, divH);\n      div.style.left = `${ox + cX}px`;\n      div.style.top = `${oy + cY}px`;\n    }\n  }, [w, h, noteFormat, cX, cY, innerR, outerR, offsetAngle]);\n\n  return (\n    <React.Fragment>\n      <canvas width={w} height={h} ref={canvas} className=\"freq-background\" />\n      {noteRefs.current.map((ref, i) => (\n        <div key={i} ref={ref} className=\"freq-note-label\">\n          {noteSymbols[notes[i]]}\n        </div>\n      ))}\n    </React.Fragment>\n  );\n});\n\nexport function CircleChart({\n  freq = 440,\n  clarity = 0,\n}: {\n  freq: number | null;\n  clarity: number | null;\n}) {\n  const [w, setW] = React.useState(400);\n  const [h, setH] = React.useState(400);\n  const surroundingDivRef = React.useRef<HTMLDivElement>(null);\n  const canvasPointerRef = React.useRef<HTMLCanvasElement>(null);\n  const { innerR, outerR } = computeInnerAndOuterRadius(w, h);\n  const angle = freqToAngle(freq || 440);\n\n  // Track resize changes and make sure to resize the circle chart accordingly\n  React.useLayoutEffect(() => {\n    function handleResize() {\n      const div = surroundingDivRef.current;\n      if (!div) {\n        return;\n      }\n      const { width, height } = div.getBoundingClientRect();\n      setW(width);\n      setH(height);\n    }\n    // Run the resizer once when the component mounts.\n    handleResize();\n\n    window.addEventListener('resize', handleResize);\n    return () => {\n      window.removeEventListener('resize', handleResize);\n    };\n  }, [setW, setH, surroundingDivRef]);\n\n  React.useEffect(() => {\n    if (!canvasPointerRef.current) {\n      return;\n    }\n    const pointerContext = canvasPointerRef.current.getContext('2d');\n    if (!pointerContext) {\n      return;\n    }\n\n    //Our draw come here\n    drawCircleChartArrow(pointerContext, [w, h], {\n      angle: 0,\n      opacity: 0.8,\n      innerR,\n      outerR,\n    });\n  }, [w, h, innerR, outerR]);\n\n  return (\n    <div ref={surroundingDivRef} className=\"freq-surround\">\n      <CircleChartBackground w={w} h={h} noteFormat=\"sharp\" />\n      {freq && <Frequency hz={freq || 440} noteFormat=\"sharp\" />}\n      <canvas\n        className=\"freq-pointer\"\n        width={w}\n        height={h}\n        ref={canvasPointerRef}\n        style={{\n          transformOrigin: 'center',\n          transform: `rotate(${angle}rad)`,\n          visibility: freq ? 'visible' : 'hidden',\n        }}\n      />\n    </div>\n  );\n}\n","import {\n  action,\n  Action,\n  createStore,\n  createTypedHooks,\n  thunk,\n  Thunk,\n} from 'easy-peasy';\nimport { Connection, ParentHandshake, WorkerMessenger } from 'post-me';\n\ntype Detector = 'mcleod' | 'autocorrelation';\ntype DisplayType = 'chart' | 'circle';\n\ninterface StoreModel {\n  windowSize: number;\n  setWindowSize: Action<StoreModel, number>;\n\n  detectorName: Detector;\n  setDetectorName: Action<StoreModel, Detector>;\n\n  displayType: DisplayType;\n  setDisplayType: Action<StoreModel, DisplayType>;\n\n  clarityThreshold: number;\n  setClarityThreshold: Action<StoreModel, number>;\n\n  enabled: boolean;\n  setEnabled: Action<StoreModel, boolean>;\n\n  stream: MediaStream | null | undefined;\n  audioOptions: MediaStreamConstraints;\n  setStream: Action<StoreModel, MediaStream | null>;\n  loading: boolean;\n  setLoading: Action<StoreModel, boolean>;\n  loaded: boolean;\n  setLoaded: Action<StoreModel, boolean>;\n  initializeStream: Thunk<StoreModel, void>;\n  stopStream: Thunk<StoreModel, void>;\n\n  workerConnection: Connection | null | undefined;\n  setWorkerConnection: Action<StoreModel, Connection | null>;\n  initializeWorker: Thunk<StoreModel, void>;\n}\n\nexport const store = createStore<StoreModel>({\n  // Default values\n  windowSize: 1024,\n  detectorName: 'mcleod',\n  displayType: 'chart',\n  clarityThreshold: 0.5,\n  enabled: false,\n  loading: false,\n  loaded: false,\n  stream: null,\n  audioOptions: { audio: { echoCancellation: true, autoGainControl: true } },\n  workerConnection: null,\n\n  setWindowSize: action((state, payload) => {\n    state.windowSize = payload;\n  }),\n  setDetectorName: action((state, payload) => {\n    state.detectorName = payload;\n  }),\n  setDisplayType: action((state, payload) => {\n    state.displayType = payload;\n  }),\n  setClarityThreshold: action((state, payload) => {\n    state.clarityThreshold = payload;\n  }),\n  setEnabled: action((state, payload) => {\n    state.enabled = payload;\n  }),\n  setStream: action((state, payload) => {\n    state.stream = payload;\n  }),\n  setLoading: action((state, payload) => {\n    state.loading = payload;\n  }),\n  setLoaded: action((state, payload) => {\n    state.loaded = payload;\n  }),\n  setWorkerConnection: action((state, payload) => {\n    state.workerConnection = payload;\n  }),\n  initializeStream: thunk(async (actions, payload, { getState }) => {\n    const state = getState();\n    const options = state.audioOptions;\n\n    actions.setLoading(true);\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia(options);\n      actions.setStream(stream);\n      actions.setLoading(false);\n      actions.setLoaded(true);\n    } catch (e) {\n      console.error(e);\n      actions.setStream(null);\n      actions.setLoading(false);\n      actions.setLoaded(false);\n    }\n  }),\n  stopStream: thunk(async (actions, payload, { getState }) => {\n    const stream = getState().stream;\n\n    if (stream) {\n      for (const track of stream.getTracks()) {\n        track.stop();\n      }\n    }\n\n    actions.setStream(null);\n    actions.setLoading(false);\n    actions.setLoaded(false);\n  }),\n  initializeWorker: thunk(async (actions) => {\n    const worker = new Worker(\n      `${process.env.PUBLIC_URL}/pitch-detection/worker.js`\n    );\n\n    const messenger = new WorkerMessenger({ worker });\n\n    try {\n      const connection = await ParentHandshake(messenger, {}, 5, 1000);\n      actions.setWorkerConnection(connection);\n    } catch (e) {\n      console.error('Failed to connect to worker', e);\n      actions.setWorkerConnection(null);\n    }\n  }),\n});\n\n// Create a version of the standard hooks that always references our `StoreModel` type\nconst typedHooks = createTypedHooks<StoreModel>();\n\nexport const useStoreActions = typedHooks.useStoreActions;\nexport const useStoreDispatch = typedHooks.useStoreDispatch;\nexport const useStoreState = typedHooks.useStoreState;\n","import React from 'react';\n\nimport './side-nav.css';\nimport 'hamburgers/dist/hamburgers.min.css';\n\nconst SideNavContext = React.createContext({\n  expanded: false,\n  toggleExpanded: () => {},\n});\n\nfunction _SideNav({\n  expanded: _expanded,\n  onToggle,\n  children,\n}: {\n  expanded?: boolean;\n  onToggle?: Function;\n  children?: React.ReactNode;\n}) {\n  // We use built-in state unless a managed state is passed in.\n  let [expanded, setExpanded] = React.useState(_expanded || false);\n  if (_expanded != null) {\n    expanded = _expanded;\n  }\n  function toggleExpanded() {\n    setExpanded(!expanded);\n    if (onToggle) {\n      onToggle(!expanded);\n    }\n  }\n\n  return (\n    <SideNavContext.Provider value={{ expanded, toggleExpanded }}>\n      <nav className={`sidenav ${expanded ? 'expanded' : ''}`}>{children}</nav>\n    </SideNavContext.Provider>\n  );\n}\n\nexport function Toggle() {\n  const { expanded, toggleExpanded } = React.useContext(SideNavContext);\n  return (\n    <div className=\"sidenav-toggle\">\n      <button\n        className={`hamburger hamburger--squeeze ${\n          expanded ? 'is-active' : ''\n        }`}\n        type=\"button\"\n        aria-label=\"Menu\"\n        aria-controls=\"navigation\"\n        onClick={toggleExpanded}\n      >\n        <span className=\"hamburger-box\">\n          <span className=\"hamburger-inner\"></span>\n        </span>\n      </button>\n    </div>\n  );\n}\n\nexport function Nav({ children }: { children: React.ReactNode }) {\n  return <div className=\"sidenav-nav\">{children}</div>;\n}\n\nexport function NavItem({\n  children,\n  ...rest\n}: { children: React.ReactNode } & React.HTMLAttributes<HTMLDivElement>) {\n  let { className, ..._rest } = rest;\n  className = 'sidenav-item ' + (className ? className : '');\n  return (\n    <div className={className} {..._rest}>\n      {children}\n    </div>\n  );\n}\n\nexport function NavIcon({ children }: { children: React.ReactNode }) {\n  return <button className=\"sidenav-icon\">{children}</button>;\n}\nexport function NavText({ children }: { children: React.ReactNode }) {\n  return <div className=\"sidenav-text\">{children}</div>;\n}\nexport function NavExtra({ children }: { children: React.ReactNode }) {\n  return <div className=\"sidenav-extra\">{children}</div>;\n}\n\nexport const SideNav = Object.assign(_SideNav, {\n  Nav,\n  NavItem,\n  NavIcon,\n  NavText,\n  NavExtra,\n});\n","import React from 'react';\nimport { Dropdown, DropdownButton, Form } from 'react-bootstrap';\nimport { useStoreActions, useStoreState } from '../../model';\n\nexport function Select({\n  selected: _selected,\n  onSelect: _onSelect,\n  choices,\n}: {\n  selected?: any;\n  onSelect?: Function;\n  choices: { value: any; desc: React.ReactNode }[];\n}) {\n  let [selected, setSelected] = React.useState(_selected);\n  if (_selected != null) {\n    selected = _selected;\n  }\n  const selectedIndex = Math.max(\n    choices.findIndex((item) => item.value === selected),\n    0\n  );\n\n  function onSelect(index: any) {\n    setSelected(choices[index].value);\n    if (_onSelect) {\n      _onSelect(choices[index].value);\n    }\n  }\n\n  return (\n    <DropdownButton\n      onSelect={onSelect}\n      title={choices[selectedIndex].desc}\n      variant=\"outline-light\"\n      as=\"span\"\n    >\n      {choices?.map(({ desc }, i) => (\n        <Dropdown.Item key={i} eventKey={'' + i}>\n          {desc}\n        </Dropdown.Item>\n      ))}\n    </DropdownButton>\n  );\n}\n\nexport function SelectWindowSize() {\n  const windowSize = useStoreState((state) => state.windowSize);\n  const setWindowSize = useStoreActions((actions) => actions.setWindowSize);\n  return (\n    <Select\n      selected={windowSize}\n      onSelect={setWindowSize}\n      choices={[\n        { value: 512, desc: '512 Samples' },\n        { value: 1024, desc: '1024 Samples' },\n        { value: 2048, desc: '2048 Samples' },\n        { value: 4096, desc: '4096 Samples' },\n      ]}\n    />\n  );\n}\n\nexport function SelectDetector() {\n  const detectorName = useStoreState((state) => state.detectorName);\n  const setDetectorName = useStoreActions((actions) => actions.setDetectorName);\n  return (\n    <Select\n      selected={detectorName}\n      onSelect={setDetectorName}\n      choices={[\n        { value: 'mcleod', desc: 'McLeod' },\n        { value: 'autocorrelation', desc: 'Autocorrelation' },\n      ]}\n    />\n  );\n}\n\nexport function SelectClarityThreshold() {\n  const clarityThreshold = useStoreState((state) => state.clarityThreshold);\n  const setClarityThreshold = useStoreActions(\n    (actions) => actions.setClarityThreshold\n  );\n\n  return (\n    <Form>\n      <Form.Group>\n        <Form.Control\n          type=\"range\"\n          value={clarityThreshold}\n          min={0.0}\n          max={1.0}\n          step={0.01}\n          onChange={(e) => setClarityThreshold(parseFloat(e.target.value))}\n        />\n      </Form.Group>\n    </Form>\n  );\n}\n\nexport function SelectDisplayType() {\n  const displayType = useStoreState((state) => state.displayType);\n  const setDisplayType = useStoreActions((actions) => actions.setDisplayType);\n\n  return (\n    <Select\n      selected={displayType}\n      onSelect={setDisplayType}\n      choices={[\n        { value: 'chart', desc: 'Linear Chart' },\n        { value: 'circle', desc: 'Circle Chart' },\n      ]}\n    />\n  );\n}\n","import React from 'react';\nimport { ListGroup, Navbar } from 'react-bootstrap';\nimport { Gear, Lightbulb, Play, Stop } from 'react-bootstrap-icons';\nimport { useStoreActions, useStoreState } from '../../model';\nimport {\n  NavIcon,\n  NavItem,\n  NavText,\n  NavExtra,\n  SideNav,\n  Toggle,\n} from '../side-nav/side-nav';\nimport {\n  SelectClarityThreshold,\n  SelectDetector,\n  SelectDisplayType,\n  SelectWindowSize,\n} from './options';\n\nexport function AppFrame({ children }: { children: React.ReactNode }) {\n  const [menuExpanded, setMenuExpanded] = React.useState(false);\n  const [running, setRunning] = React.useState(false);\n  const clarityThreshold = useStoreState((state) => state.clarityThreshold);\n\n  const { initializeStream, stopStream, setEnabled } = useStoreActions(\n    (actions) => actions\n  );\n\n  React.useEffect(() => {\n    if (running) {\n      (async () => {\n        await initializeStream();\n        setEnabled(true);\n        console.log('Stream Initialized');\n      })();\n    } else {\n      (async () => {\n        setEnabled(false);\n        await stopStream();\n        console.log('Stream Stopped');\n      })();\n    }\n\n    return stopStream;\n  }, [initializeStream, running, setEnabled, stopStream]);\n\n  return (\n    <React.Fragment>\n      <Navbar bg=\"primary\" variant=\"dark\">\n        <Navbar.Brand>Pitch Detector</Navbar.Brand>\n      </Navbar>\n      <div className=\"main-container\">\n        <SideNav expanded={menuExpanded} onToggle={setMenuExpanded}>\n          <Toggle />\n          <SideNav.Nav>\n            <NavItem\n              className={running ? 'active' : ''}\n              onClick={() => {\n                setRunning(!running);\n              }}\n            >\n              {running ? (\n                <React.Fragment>\n                  <NavIcon>\n                    <Stop size=\"20\" />\n                  </NavIcon>\n                  <NavText>Stop</NavText>\n                </React.Fragment>\n              ) : (\n                <React.Fragment>\n                  <NavIcon>\n                    <Play size=\"20\" />\n                  </NavIcon>\n                  <NavText>Start</NavText>\n                </React.Fragment>\n              )}\n            </NavItem>\n            <NavItem\n              onClick={() => {\n                setMenuExpanded(!menuExpanded);\n              }}\n            >\n              <NavIcon>\n                <Gear size=\"20\" />\n              </NavIcon>\n              <NavText>Settings</NavText>\n            </NavItem>\n            <NavExtra>\n              <ListGroup variant=\"flush\" color=\"primary\">\n                <ListGroup.Item>\n                  <div className=\"setting\">\n                    <span className=\"setting-desc\">Window Size</span>\n                    <SelectWindowSize />\n                  </div>\n                </ListGroup.Item>\n                <ListGroup.Item>\n                  <div className=\"setting\">\n                    <span className=\"setting-desc\">Detector</span>\n                    <SelectDetector />\n                  </div>\n                </ListGroup.Item>\n                <ListGroup.Item>\n                  <div className=\"setting\">\n                    <span className=\"setting-desc\">\n                      Clarity Threshold ({clarityThreshold})\n                    </span>\n                    <SelectClarityThreshold />\n                  </div>\n                </ListGroup.Item>\n                <ListGroup.Item>\n                  <div className=\"setting\">\n                    <span className=\"setting-desc\">Display Type</span>\n                  </div>\n                  <SelectDisplayType />\n                </ListGroup.Item>\n              </ListGroup>\n            </NavExtra>\n            <NavItem\n              className={'mt-auto' + (running ? '' : ' active')}\n              onClick={() => {\n                // The about screen automatically shows when the app is not running,\n                // so this is a shortcut to show the about screen\n                setRunning(false);\n              }}\n            >\n              <NavIcon>\n                <Lightbulb size=\"20\" />\n              </NavIcon>\n              <NavText>About</NavText>\n            </NavItem>\n          </SideNav.Nav>\n        </SideNav>\n\n        <main role=\"main\">{children}</main>\n      </div>\n    </React.Fragment>\n  );\n}\n","import React from 'react';\n\nexport function About() {\n  return (\n    <div className=\"container\">\n      <h2>A Rust + WebAssembly Pitch Detector</h2>\n      <h3>Authors</h3>\n      <span>Alessandro Genova, Jason Siefken</span>\n      <h3>Core Library</h3>\n      <span>\n        <a\n          href=\"https://github.com/alesgenova/pitch-detection\"\n          target=\"_blank\"\n          rel=\"noreferrer\"\n        >\n          Source\n        </a>\n        <br />\n        (rust)\n      </span>\n      <h3>Demo App</h3>\n      <span>\n        <a\n          href=\"https://github.com/alesgenova/pitch-detection-app\"\n          target=\"_blank\"\n          rel=\"noreferrer\"\n        >\n          Source\n        </a>\n        <br />\n        (wasm, react)\n      </span>\n    </div>\n  );\n}\n","import React from 'react';\n\nimport PitchComponent from './components/pitch';\nimport { PitchMonitor } from './components/pitch/pitch-monitor';\nimport { CircleChart } from './components/circle-chart/circle-chat';\nimport { AppFrame } from './components/main/app-frame';\nimport { useStoreActions, useStoreState } from './model';\nimport { About } from './components/main/about';\n\nfunction App() {\n  const POWER_THRESHOLD = 0.15;\n\n  const detectorName = useStoreState((state) => state.detectorName);\n  const windowSize = useStoreState((state) => state.windowSize);\n  const clarityThreshold = useStoreState((state) => state.clarityThreshold);\n  const displayType = useStoreState((state) => state.displayType);\n  const enabled = useStoreState((state) => state.enabled);\n\n  const { loaded, stream, workerConnection } = useStoreState((state) => ({\n    loaded: state.loaded,\n    loading: state.loading,\n    stream: state.stream,\n    workerConnection: state.workerConnection,\n  }));\n\n  const { initializeWorker } = useStoreActions((actions) => actions);\n\n  React.useEffect(() => {\n    (async () => {\n      await initializeWorker();\n      console.log('Worker initialized');\n    })();\n  }, [initializeWorker]);\n\n  let mainDisplay = <About />;\n  if (loaded && stream && workerConnection) {\n    const pitchRenderer =\n      displayType === 'circle' ? CircleChart : PitchComponent;\n    mainDisplay = (\n      <PitchMonitor\n        stream={stream}\n        detectorName={detectorName}\n        workerConnection={workerConnection}\n        windowSize={windowSize}\n        powerThreshold={POWER_THRESHOLD}\n        clarityThreshold={clarityThreshold}\n        enabled={enabled}\n        pitchRenderer={pitchRenderer}\n      />\n    );\n  }\n\n  return <AppFrame>{mainDisplay}</AppFrame>;\n}\n\nexport default App;\n","import { ReportHandler } from 'web-vitals';\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry);\n      getFID(onPerfEntry);\n      getFCP(onPerfEntry);\n      getLCP(onPerfEntry);\n      getTTFB(onPerfEntry);\n    });\n  }\n};\n\nexport default reportWebVitals;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport reportWebVitals from './reportWebVitals';\n\nimport 'bootstrap/dist/css/bootstrap.min.css';\nimport { StoreProvider } from 'easy-peasy';\nimport { store } from './model';\n\nReactDOM.render(\n  <React.StrictMode>\n    <StoreProvider store={store}>\n      <App />\n    </StoreProvider>\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n","// Encoder and decoder for melody notes so that they can be added to URL.\n// Binary data is base64 encoded with some characters replaced so that\n// it is safe to be used in URL. Encoding uses lossy compression, original\n// data loses some timing accuracy.\n//\n// Binary starts with 16-bit checksum.\n//\n// Notes follow either in 16-bit or 24-bit format.\n// 16-bit:\n// FXXXXXYYYYZZZZZZ\n// 24-bit:\n// FXXXXXXXXXXXYYYYYYZZZZZZ\n//\n// F: 0=16-bit note, 1=24-bit note\n// X: silence before this note, relative to the end of previous note (0.1 ms)\n// Y: duration (0.1 ms)\n// Z: pitch\n\n// To save space, use larger precision.\nconst PRECISION = 100; // in milliseconds\n\nconst SHORT_BITS = {\n  start: 5,\n  duration: 4,\n  pitch: 6,\n};\n\nconst LONG_BITS = {\n  start: 11,\n  duration: 6,\n  pitch: 6,\n};\n\n// Returns true if this note can be encoded with 16 bits.\nfunction canUseShort(start, duration) {\n  return (start < (1 << (SHORT_BITS.start)) &&\n    duration < (1 << SHORT_BITS.duration));\n}\n\n// Replaces some characters in base64 encoded data to be URL safe (RFC 3986):\n// '+' -> '_'\n// '/' -> '.'\n// '=' -> '-'\nfunction safeBase64(data) {\n  return data\n    .replace(/\\+/g, '_')\n    .replace(/\\//g, '.')\n    .replace(/=/g, '-');\n}\n\nfunction unsafeBase64(data) {\n  return data\n    .replace(/_/g, '+')\n    .replace(/\\./g, '/')\n    .replace(/-/g, '=');\n}\n\nexport function decodeS1(data) {\n  const notes = [];\n  const base64 = unsafeBase64(data);\n  const buffer = Buffer.from(base64, 'base64');\n\n  if (buffer.length < 2) {\n    throw new Error('No content');\n  }\n\n  let checksum = 0;\n  // read original checksum\n  const origChecksum = buffer.readUInt16BE(0);\n\n  // read content\n  let lastEnd = 0;\n  let pos = 2; // skip checksum, first 2 bytes\n  while (pos < buffer.length) {\n    // check first bit\n    const isLong = buffer.readUIntBE(pos, 1) & 128;\n    let bytes;\n    let start;\n    let duration;\n    let pitch;\n    if (isLong) {\n      // read 24-bit value\n      bytes = 3;\n      const value = buffer.readUIntBE(pos, bytes);\n      start = (value >> (LONG_BITS.duration + LONG_BITS.pitch)) & ((1 << LONG_BITS.start) - 1);\n      duration = (value >> LONG_BITS.pitch) & ((1 << LONG_BITS.duration) - 1);\n      pitch = value & ((1 << LONG_BITS.pitch) - 1)  & ((1 << LONG_BITS.pitch) - 1);\n      checksum += value;\n    } else {\n      // read 16-bit value\n      bytes = 2;\n      const value = buffer.readUIntBE(pos, bytes);\n      start = (value >> (SHORT_BITS.duration + SHORT_BITS.pitch)) & ((1 << SHORT_BITS.start) - 1);\n      duration = (value >> SHORT_BITS.pitch) & ((1 << SHORT_BITS.duration) - 1);\n      pitch = value & ((1 << SHORT_BITS.pitch) - 1)  & ((1 << SHORT_BITS.pitch) - 1);\n      checksum += value;\n    }\n\n    const note = {\n      start: lastEnd + start * PRECISION,\n      duration: duration * PRECISION,\n      pitch,\n    };\n    notes.push(note);\n    lastEnd = note.start + note.duration;\n    pos += bytes;\n  }\n\n  // 16-bit checksum\n  if ((checksum & 65535) !== origChecksum) {\n    throw new Error('Corrupted data: invalid checksum');\n  }\n\n  return notes;\n}\n\nexport function encodeS1(data) {\n  const buffers = [];\n  let lastPos = 0;\n  let checksum = 0;\n\n  function bitHandle(value, valueBits, shiftBits) {\n    const max = (1 << valueBits) - 1;\n    if (value > max) {\n      throw new Error(`${valueBits} bits not enough for value ${value}, use another encoding`);\n    }\n    return value << shiftBits;\n  }\n\n  for (let i = 0; i < data.notes.length; i++) {\n    const note = data.notes[i];\n    const start = Math.floor((note.start - (lastPos * PRECISION)) / PRECISION);\n    const duration = Math.floor(note.duration / PRECISION);\n    lastPos += start + duration;\n    const pitch = note.pitch;\n\n    if (canUseShort(start, duration)) {\n      // we can write a note with 16 bits\n      let num = bitHandle(start, SHORT_BITS.start, SHORT_BITS.duration + SHORT_BITS.pitch);\n      num += bitHandle(duration, SHORT_BITS.duration, SHORT_BITS.pitch);\n      num += bitHandle(pitch, SHORT_BITS.pitch, 0);\n      const bytes = Buffer.alloc(2);\n      bytes.writeUInt16BE(num);\n      buffers.push(bytes);\n      checksum += num;\n    } else {\n      // write a note with 24 bits\n      let num = 1 << 23; // first bit indicates 24-bit note\n      num += bitHandle(start, LONG_BITS.start, LONG_BITS.duration + LONG_BITS.pitch);\n      num += bitHandle(duration, LONG_BITS.duration, LONG_BITS.pitch);\n      num += bitHandle(pitch, LONG_BITS.pitch, 0);\n      const bytes = Buffer.alloc(3);\n      bytes.writeUIntBE(num, 0, 3);\n      buffers.push(bytes);\n      checksum += num;\n    }\n  }\n\n  // add 16-bit checksum to the beginning of buffer\n  const checksumBuf = Buffer.alloc(2);\n  checksumBuf.writeUInt16BE(checksum & 65535);\n  buffers.unshift(checksumBuf);\n\n  const output = Buffer.concat(buffers).toString('base64');\n  return safeBase64(output);\n}\n"],"sourceRoot":""}